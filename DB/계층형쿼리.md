# 계층형 쿼리

오라클은 계층형 구조를 보다 간편하게 표현할 수 있도록 제공하는데 이것이 바로 계층형 쿼리이다.

계층형 구조란 상하 수직 관계의 구조로 회사의 직급이나 구조, 대학의 학과 등이 있다.

|부서번호|부서명|
|-------|------|
|10|총무기획부|
|20|__마케팅|
|30|__구매/생산부|
|170|____생산팀|
|180|____건설팀|
|200|____운영팀|
...

<br>

<span style="color:yellow">"_" 은 테이블 안에 들여쓰기를 표현하기위해 임의로 넣은 기호</span>이며 실제 결과로는 들여쓰기가 되어 계층구도를 한눈에 파악할 수 있다.

위와같이 계층형쿼리를 사용하여 결과를 조회하는 문법은 다음과 같다.

<br>


입력
```
SELECT department_id, LPAD(' ', 3*(LEVEL-1)) || department_name, LEVEL
FROM departments
START WITH parent_id IS NULL
CONNECT BY PRIOR department_id = parent_id;
```

결과

|DEPARTMENT_ID|LPAD('',3*(LEVEL-1))DEPARTMENT_NAME|LEVEL|
|-------------|-------------------------------------|-----|
|10|총무기획부|1|
|20|---마케팅|1|
|30|---구매/생산부|1|
|170|------생산팀|1|
|180|------건설팀|1|
|200|------운영팀|1|
...

<br>


START WITH 조건은 계층형 구조에서 최상위 계층의 로우를 식별하는 조건을 명시하는 부분이며
상위 부서번호값을 가지고 있는 parent_id 컬럼의 값이 null인, 즉 최상위 계층에 해당하는 레코드를 찾게 된다.

CONNECT BY 조건은 계층형 구조가 어떤 조건으로 연결되는지 기술하는 부분으로서 예시의 경우
PRIOR 컬럼명 = 컬럼명 형식으로 상위계층의 부서명과 해당 레코드의 상위계층의 부서명을 조건으로 엮어서 계층형쿼리를 표현하게 된다.

컬럼명으로 명시된 LEVEL은 계층형쿼리에서만 사용가능한 의사코드로서 계층형 구조에 따른 LEVEL값을 자동으로 반환해준다.

계층형쿼리를 사용할 경우에 ORDER BY 를 작성하여 정렬 순서를 변경할 수 있지만 order by를 사용하면 계층형 구조가 뒤죽박죽이 되어버린다. 따라서 계층형 쿼리를 사용할때 계층형 구조를 깨뜨리지 않으면서 정렬 순서를 변경하려면 ORDER SIBLINGS BY 컬럼명 을 사용해야 한다.